<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat Turquesa Discord</title>
<style>
:root{
  --bg-main:#0d1b1b;
  --bg-sidebar:#0b1414;
  --bg-header:#0f2626;
  --bg-bubble-you:#1abc9c;
  --bg-bubble-other:#16a085;
  --text-main:#e0f7f7;
  --text-muted:#7fcccc;
  --accent:#1abc9c;
}
body{margin:0;font-family:'Segoe UI',Arial,sans-serif;background:var(--bg-main);color:var(--text-main);}
.app{max-width:1100px;margin:0 auto;height:100vh;display:flex;flex-direction:column;border-radius:8px;overflow:hidden;}
header{background:var(--bg-header);padding:14px 18px;display:flex;justify-content:space-between;align-items:center;}
.container{flex:1;display:flex;overflow:hidden;}
.sidebar{width:220px;background:var(--bg-sidebar);padding:12px;overflow-y:auto;}
.sidebar h3{color:var(--accent);margin-bottom:8px;}
.main{flex:1;display:flex;flex-direction:column;}
.messages{flex:1;overflow-y:auto;padding:12px;scroll-behavior:smooth;}
.message{margin-bottom:8px;display:flex;flex-direction:column;}
.meta{font-size:12px;color:var(--text-muted);margin-bottom:2px;}
.bubble{padding:10px 14px;border-radius:15px;max-width:70%;display:inline-block;word-wrap:break-word;}
.you .bubble{background:var(--bg-bubble-you);color:#fff;align-self:flex-end;}
.other .bubble{background:var(--bg-bubble-other);color:#fff;align-self:flex-start;}
img.message-img{max-width:60%;border-radius:12px;margin-top:4px;}
.input-area{display:flex;padding:12px;border-top:1px solid var(--text-muted);flex-wrap:wrap;background:var(--bg-header);}
input[type=text],#input{flex:1;padding:10px;border:1px solid var(--text-muted);border-radius:8px;margin-right:8px;margin-bottom:4px;background:#123c3c;color:#fff;}
button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;margin-left:4px;margin-bottom:4px;}
#imgInput{flex-basis:100%;}
.join-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;}
.join-card{background:#082020;padding:22px;border-radius:10px;width:90%;max-width:320px;box-shadow:0 10px 30px rgba(0,0,0,.5);}
.you{font-weight:600;}
.sys{color:var(--text-muted);font-style:italic;}
@media(max-width:800px){.container{flex-direction:column;}.sidebar{width:100%;height:120px;order:2;overflow-x:auto;}.main{order:1;}}
</style>
</head>
<body>

<div id="joinOverlay" class="join-overlay">
  <div class="join-card">
    <h2>Ingresa tu nombre</h2>
    <form id="joinForm">
      <input id="nameInput" type="text" placeholder="Tu nombre" />
      <button type="submit">Entrar</button>
    </form>
  </div>
</div>

<div class="app">
  <header>
    <h1>Chat Turquesa Discord</h1>
    <small id="status">Desconectado</small>
  </header>
  <div class="container">
    <aside class="sidebar">
      <h3>Usuarios</h3>
      <div id="users">(ninguno)</div>
    </aside>
    <main class="main">
      <div id="messages" class="messages"></div>
      <form id="form" class="input-area">
        <input id="input" type="text" placeholder="Escribe un mensaje..." />
        <input id="imgInput" type="file" accept="image/*" />
        <button type="submit">Enviar</button>
        <button type="button" onclick="sendReaction('üëç')">üëç</button>
        <button type="button" onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
      </form>
    </main>
  </div>
</div>

<audio id="msgSound" src="https://www.myinstants.com/media/sounds/pling.mp3" preload="auto"></audio>

<script>
document.addEventListener('DOMContentLoaded',()=>{
const WS_URL=(location.protocol==='https:'?'wss':'ws')+'://'+location.hostname+(location.port?':'+location.port:'')+'/ws';
const joinOverlay=document.getElementById('joinOverlay');
const joinForm=document.getElementById('joinForm');
const nameInput=document.getElementById('nameInput');
const statusEl=document.getElementById('status');
const usersEl=document.getElementById('users');
const messagesEl=document.getElementById('messages');
const form=document.getElementById('form');
const input=document.getElementById('input');
const imgInput=document.getElementById('imgInput');
const msgSound=document.getElementById('msgSound');

let ws=null,username='',reconnectAttempts=0,MAX_RECONNECT=5;

function escapeHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function addSystemMessage(text){const el=document.createElement('div');el.className='message sys';el.textContent=text;messagesEl.appendChild(el);messagesEl.scrollTop=messagesEl.scrollHeight;}
function renderUsers(users){if(!users||users.length===0)usersEl.innerHTML='(ninguno)';else usersEl.innerHTML=users.map(u=>u===username?`<div class="you">${u} (t√∫)</div>`:`<div>${u}</div>`).join('');}

function addMessage(msg){
  const el=document.createElement('div');
  el.className='message '+(msg.name===username?'you':'other');
  const time=msg.when?new Date(msg.when).toLocaleTimeString():'';
  let bubbleContent = msg.isImage ? `<img class="message-img" src="${msg.text}" />` : escapeHtml(msg.text);
  el.innerHTML=`<div class="meta">${escapeHtml(msg.name)} ¬∑ ${time}</div><div class="bubble">${bubbleContent}</div>`;
  messagesEl.appendChild(el);
  messagesEl.scrollTop=messagesEl.scrollHeight;
  if(msg.name!==username) msgSound.play();
}

function tryConnect(){
  if(ws&&(ws.readyState===WebSocket.OPEN||ws.readyState===WebSocket.CONNECTING)) return;
  ws=new WebSocket(WS_URL);
  ws.addEventListener('open',()=>{statusEl.textContent='Conectado'; reconnectAttempts=0; if(username) ws.send(JSON.stringify({type:'join',name:username}));});
  ws.addEventListener('message',ev=>{
    let data;
    try{data=JSON.parse(ev.data);}catch(e){return;}
    if(data.type==='users') renderUsers(data.users);
    else if(data.type==='message') addMessage(data);
    else if(data.type==='system') addSystemMessage(data.text);
    else if(data.type==='history'){ data.messages.forEach(msg=>addMessage(msg)); }
  });
  ws.addEventListener('close',()=>{statusEl.textContent='Desconectado'; if(reconnectAttempts<MAX_RECONNECT){const delay=Math.pow(2,reconnectAttempts)*1000; addSystemMessage(`Conexi√≥n cerrada. Reintentando en ${delay/1000}s...`); reconnectAttempts++; setTimeout(tryConnect,delay);} else addSystemMessage('No se pudo reconectar.');});
  ws.addEventListener('error',()=>{addSystemMessage('Error de WebSocket.'); statusEl.textContent='Error';});
}

function sendReaction(emoji){if(ws && ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify({type:'message', text:emoji}));}

if(joinForm) joinForm.addEventListener('submit',e=>{
  e.preventDefault();
  const v=nameInput.value.trim();
  if(!v) return alert('Ingresa un nombre');
  username=v;
  joinOverlay.style.display='none';
  tryConnect();
});

if(form) form.addEventListener('submit',e=>{
  e.preventDefault();
  if(!ws || ws.readyState!==WebSocket.OPEN){addSystemMessage('No hay conexi√≥n'); return;}
  const txt=input.value.trim();
  if(txt) ws.send(JSON.stringify({type:'message', text:txt}));
  if(imgInput.files.length>0){
    const file = imgInput.files[0];
    const reader = new FileReader();
    reader.onload = ()=> ws.send(JSON.stringify({type:'message', text:reader.result, isImage:true}));
    reader.readAsDataURL(file);
  }
  input.value='';
  imgInput.value='';
});
});
</script>

</body>
</html>
